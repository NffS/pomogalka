<!doctype html>
<html>

<head>
    <title>unquote</title>
    <meta name="viewport" content="width=device-width, minimum-scale=0, initial-scale=1.0, user-scalable=yes">
    <script src="js/md5.js"></script>
    <script src="components/platform/platform.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="js/gmaps.js"></script>
    <script src="js/url.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdn.socket.io/socket.io-1.0.6.js"></script>
    <script src="js/jsonrpc-ws-client.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/json2/20110223/json2.js"></script>
    <script src="js/jstorage.js"></script>
    <link rel='stylesheet' type='text/css' href='style.css'>
    <script src="elements/request-page/request-page.js"></script>

    <link rel="import" href="components/font-roboto/roboto.html">
    <link rel="import" href="components/core-icons/core-icons.html">
    <link rel="import" href="components/core-toolbar/core-toolbar.html">
    <link rel="import" href="components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="components/paper-button/paper-button.html">
    <link rel="import" href="components/paper-tabs/paper-tabs.html">
    <link rel="import" href="components/core-drawer-panel/core-drawer-panel.html">
    <link rel="import" href="components/core-menu/core-submenu.html">
    <link rel="import" href="components/core-item/core-item.html">
    <link rel="import" href="components/core-icon-button/core-icon-button.html">
    <link rel="import" href="components/core-scaffold/core-scaffold.html">
    <link rel="import" href="components/core-header-panel/core-header-panel.html">
    <link rel="import" href="components/core-menu/core-menu.html">
    <link rel="import" href="components/core-item/core-item.html">
    <link rel="import" href="components/core-pages/core-pages.html">
    <link rel="import" href="components/core-icon/core-icon.html">
    <link rel="import" href="components/core-input/core-input.html">
    <link rel="import" href="components/paper-toast/paper-toast.html">
    <link rel="import" href="elements/request-form/request-form.html">
    <link rel="import" href="elements/registration-form/registration-form.html">
    <link rel="import" href="elements/request-page/request-page.html">
    <link rel="import" href="elements/login-form/login-form.html">

    <style>

    </style>
</head>

<body unresolved touch-action="auto">
    <core-scaffold responsiveWidth="1333px" id="core_scaffold">
        <core-header-panel mode="seamed" id="core_header_panel" navigation flex>
            <core-toolbar id="core_toolbar">
                <core-icon icon="search" id="core_icon"></core-icon>
                <core-input placeholder="Search" id="core_input"></core-input>
            </core-toolbar>
            <core-menu selected="Map" valueattr="label" selectedindex="0" id="core_menu" class="" theme="core-light-theme">
                <core-item label="Map" icon="settings" size="24" id="main_item" horizontal center layout active></core-item>
                <core-item label="Request Form" icon="settings" size="24" id="request_form_item" horizontal center layout></core-item>
                <core-item label="Request Page" icon="settings" size="24" id="request_page_item" horizontal center layout></core-item>
                <core-item label="Registration From" icon="settings" size="24" id="registration_form_item" horizontal center layout></core-item>
                <core-item label="Login Page" icon="settings" size="24" id="login_form_item" horizontal center layout></core-item>
            </core-menu>

        </core-header-panel>
        <div id="div" tool>
            <span>Сервис взаимопомощи</span>
            <span>
                <core-icon icon="account-circle"></core-icon>
            </span>
        </div>

        <core-pages class="content" id="page">
            <div class="content"><div class="map" id="map"></div></div>
            <div><request-form></request-form></div>
            <div>
                <request-page>
                </request-page>
            </div>
            <div><registration-form></registration-form></div>
            <div><login-form></login-form></div>
        </core-pages>

        <paper-toast id="toast" class="capsule" text="text" style="margin: auto"></paper-toast>
    </core-scaffold>
</body>


</html>
<script>
    //    var core_icon_button = document.getElementById('core_icon_button');
    //
    //    core_icon_button.addEventListener('core-select', function() {
    //        //alert("Selected: " + tabs.selected);
    //    });


    document.querySelector("#main_item").onclick = function(e) {
        page = document.querySelector("core-pages#page");
        page.selected = 0;
    };

    document.querySelector("#request_form_item").onclick = function(e) {
        page = document.querySelector("core-pages#page");
        page.selected = 1;
    };

    document.querySelector("#request_page_item").onclick = function(e) {
        page = document.querySelector("core-pages#page");
        page.selected = 2;
    };

    document.querySelector("#registration_form_item").onclick = function(e) {
        page = document.querySelector("core-pages#page");
        page.selected = 3;
    };

    document.querySelector("#login_form_item").onclick = function(e) {
        page = document.querySelector("core-pages#page")
        page.selected = 4;
    };

    var map = new GMaps({
        div: '#map',
        lat: 46.28,
        lng: 30.44,
        width: screen.availWidth,
        height: screen.availHeight
    });



    GMaps.geolocate({
        success: function(position) {
            map.setCenter(position.coords.latitude, position.coords.longitude);
            map.addMarker({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
//                color: 'blue',
                title: "Собор ёба!",
                animation: 'BOUNCE',
                infoWindow: {
                    content: "<div class='circular' style='background: url(img/photo.jpg) no-repeat;'></div>" +
                            "<h2>Собор</h2>" +
                            "<p>Описание описывает описывает описывает описывает описывает описывает описывает описывает " +
                            "описывает описывает описывает описывает описывает описывает описывает описывает описывает " +
                            "описывает описывает описывает описывает описывает описывает " +
                            "описывает описывает описывает описывает описывает описывает</p>" +
                            "<paper-button raisedButton class='colored' label='Подробнее'></paper-button>"
                }

            });
        },
        error: function(error) {
            alert('Geolocation failed: '+error.message);
        },
        not_supported: function() {
            alert("Your browser does not support geolocation");
        }
    });

    function openRequest(requestId) {
        rpc.call('requests.getRequest', requestId, function (resp) {
            if(resp.error) return;
            updateRequestPage(resp.result);
        });
    }

    function updateRequestPage(request){
        var rp = document.querySelector("request-page");
        if(!request.coord)
            request.coord = { lat: 46.484948, lng: 30.741102 };
        rp.mapUrl = GMaps.staticMapURL({
            size: [document.querySelector("request-page").clientWidth, 192],
            lat: request.coord.lat || 46.484948,
            lng: request.coord.lng || 30.741102,
            markers: {
                lat: request.coord.lat || 46.484948,
                lng: request.coord.lng || 30.741102
            }
        });
        rp.helps = [];
        rp.helpers = [];
        rp.candidates = [];

        for (attr in request) {
            rp[attr] = request[attr];
        }
        chagePage(2);
        setUrlHash("request" + request._id);
    }

    function setUrlHash(hash){
        var url = new Url(document.location.href);
        url.hash = hash;
        document.location.href = url;
    }

    function chagePage(n) {
        page = document.querySelector("core-pages#page");
        page.selected = n;
    }

    function checkHash() {
        var url = new Url(document.location.href);
        if (url.hash != "") {
            if (url.hash.indexOf("request") == 0) {
                openRequest(url.hash.substring(7));
            }
        }
    }

    $(document).ready(function(){
        var socket = io('http://localhost:9000');

        socket.on('connect', function(){
            window.rpc = new rpcClient(socket);
            rpc.call('requests.getAllMarkers',function(resp){
                console.log(resp.result);
                map.addMarkers(resp.result);
            });
//            socket.send( JSON.stringify({id:1,method:"rpc,getAllMarkers",params:""}) )
        });

//        socket.on('message', function(r){ console.log("response: " + r) });
        socket.connect();

        window.addEventListener('polymer-ready', function() {
            checkHash();
        });
    });


</script>
