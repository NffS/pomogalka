<link rel="import" href="../../components/core-scroll-header-panel/core-scroll-header-panel.html">
<link rel="import" href="../../components/core-scroll-header-panel/demos/lorem-ipsum.html">
<link rel="import" href="../../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../components/core-tooltip/core-tooltip.html">
<link rel="import" href="../../components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../components/core-collapse/core-collapse.html">
<link rel="import" href="../request-description/request-description.html">
<link rel="import" href="../../components/paper-shadow/paper-shadow.html" >
<link rel="import" href="../../components/core-icons/core-icons.html">
<link rel="import" href="../../components/paper-button/paper-button.html">


<polymer-element name="request-page" attributes="title address user description helperAmount mapUrl">
    <template>
        <style shim-shadowdom>
            html, body {
                height: 100%;
            }
            :host {
                position: absolute;
                width: 100%;
                height: 100%;
                box-sizing: border-box;
            }
            body {
                margin: 0;
                font-family: sans-serif;
                color: #333;
            }

            core-scroll-header-panel {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
            }

            /* background for toolbar when it is at its full size */
            core-scroll-header-panel::shadow #headerBg {

                background-color: #ffffff;

            }

            /* background for toolbar when it is condensed */
            core-scroll-header-panel::shadow #condensedHeaderBg {
                background-color: #ffffff;
            }

            core-toolbar {
                color: #f1f1f1;
                fill: #f1f1f1;
                background-color: transparent;
            }

            .title {
                -webkit-transform-origin: 0;
                transform-origin: 0;
                font-size: 40px;
            }

            .content {
                /*padding: 10px 30px;*/
                width: 100%;
                height: 100%;
            }

            .card {
                background:#FFF;
                /*border:1px solid #AAA;*/
                /*border-bottom:3px solid #BBB;*/
                padding:0px;
                margin:15px;
                overflow:hidden;
                border-radius: 2px;
            }

            .float-left .card {
                float:left;
                width:350px;
                /*height:270px;*/
            }

            .circular {
                width: 54px;
                height: 54px;
                border-radius: 27px;
                -webkit-border-radius: 27px;
                -moz-border-radius: 27px;
                margin: 6px;
                float: left;
            }

            h1 {
                margin: 0;
                padding: 10px;
                padding-bottom: 0;
            }

            .titlebg {
                width: 100%;
                border-radius: 10px;
                padding-top: 203px;
                top: -93px;
                position: relative;
                background: rgba(0, 0, 0, 0.3);
            }

        </style>
        <core-scroll-header-panel condenses>

            <paper-shadow></paper-shadow>
            <core-toolbar style="background-image: url({{mapUrl}});"  class="tall">
                <div class="middle" >
                    адрес: {{address}}<br>
                    кол-во человек: {{helperAmount}}
                </div>
                <div class="bottom title titlebg">{{title}}</div>
            </core-toolbar>

            <div class="content" id="content">
                <div class="float-left" id="float-left">
                    <div class="card paper-shadow-top-z-1">
                        <request-description>
                            {{description}}<br>
                            <paper-button raisedButton id="helpButton" class='colored' label='Помочь'></paper-button>
                        </request-description>
                    </div>
                    <div class="card paper-shadow-top-z-1">
                        <h1>Помогли</h1>
                        <template repeat="{{help in helps}}">
                            <template repeat="{{user in help.users}}">
                                <core-tooltip label="{{user.name}} {{user.surname}}" position="top">
                                    <img class="circular" src="img/{{user.avatar}}">
                                </core-tooltip>
                            </template>
                        </template>
                        <h1>Собираються</h1>
                        <template repeat="{{user in helpers}}">
                            <core-tooltip label="{{user.name}} {{user.surname}}" position="top">
                                <img class="circular" src="img/{{user.avatar}}">
                            </core-tooltip>
                        </template>
                        <div id="candidates">
                            <h1>Предлогают</h1>
                            <template repeat="{{user in candidates}}">
                                <core-tooltip label="{{user.name}} {{user.surname}}" position="top">
                                    <img class="circular" src="img/{{user.avatar}}">
                                </core-tooltip>
                            </template>
                        </div>
                    </div>
                    <div class="card paper-shadow-top-z-1">
                        <paper-button label="Обсуждение" id="chat_collapse_button"></paper-button>
                        <core-collapse id="chat_collapse">
                            Ебаный сорт
                        </core-collapse>
                    </div>
                    <div class="card paper-shadow-top-z-1"><request-description>{{description}}</request-description></div>
                    <div class="card paper-shadow-top-z-1"><request-description>{{description}}</request-description></div>
                    <div class="card paper-shadow-top-z-1"><request-description>{{description}}</request-description></div>
                    <div class="card paper-shadow-top-z-1"><request-description>{{description}}</request-description></div>
                    <div class="card paper-shadow-top-z-1"><request-description>{{description}}</request-description></div>
                </div>
            </div>
        </core-scroll-header-panel>
    </template>
    <script>
        Polymer("request-page",{
            ready: function(){
                var context = this.$;
                (window.onresize = function(){
                    var clientWidth = context.content.clientWidth;
                    var cardWidth = 390;
                    var margin = clientWidth > cardWidth ? (clientWidth % cardWidth) / 2 : 2;
                    context["float-left"].style.marginLeft = margin.toFixed() + "px";

                })();

                context.chat_collapse_button.addEventListener('click', function(){ context.chat_collapse.toggle(); });
            },
            userChanged:function(old,user) {
                var tost = document.querySelector("#toast");
                var context = this.$;
                var pageRequest = this;
                var request_id = this._id;
                context.candidates.style.display = "none";

                if($.jStorage.get("user") != null){
                    if(user._id == $.jStorage.get("user")._id) {
                        context.helpButton.style.display = "none";
                        context.candidates.style.display = "block";
                    }else{
                        context.helpButton.addEventListener('click', function(){
                            //TODO change button state and reload request elements
                            rpc.call('requests.addCandidate', $.jStorage.get("user"),request_id, function (resp){
                                if(resp.error){
                                    tost.text= resp.error.message;
                                    tost.show();
                                } else {
                                    pageRequest.candidates.push($.jStorage.get("user"));
                                    tost.text= "Помощь принята!";
                                    tost.show();
                                }

                            });
                            this.removeEventListener('click',arguments.callee,false);
                        });
                    }
                }else{
                    context.helpButton.style.display = "none";
                }
            },
            candidatesChanged:function(old,candidates) {
                candidates;
            }
        });

    </script>
</polymer-element>